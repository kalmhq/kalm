apiVersion: v1
kind: Namespace
metadata:
  name: kapp-test
---
apiVersion: core.kapp.dev/v1alpha1
kind: Plugin
metadata:
  name: kapp-configurable-probes
spec:
  src: |
    function addProbesForContainer(container) {
      var config = getConfig();

      if (!config) {
        return
      }

      if (config.readinessProbe) {
        container.readinessProbe = config.readinessProbe
      }

      if (config.livenessProbe) {
        container.livenessProbe = config.livenessProbe
      }
    }

    function AfterPodTemplateGeneration(pod) {
      var containers = pod.spec.containers;
      containers.forEach(addProbesForContainer)
      return pod;
    }
  configSchema:
    type: object
    properties:
      livenessProbe:
        description: Probe describes a health check to be performed against
          a container to determine whether it is alive or ready to receive
          traffic.
        properties:
          exec:
            description: One and only one of the following should be specified.
              Exec specifies the action to take.
            properties:
              command:
                description: Command is the command line to execute inside
                  the container, the working directory for the command  is
                  root ('/') in the container's filesystem. The command
                  is simply exec'd, it is not run inside a shell, so traditional
                  shell instructions ('|', etc) won't work. To use a shell,
                  you need to explicitly call out to that shell. Exit
                  status of 0 is treated as live/healthy and non-zero
                  is unhealthy.
                items:
                  type: string
                type: array
            type: object
          failureThreshold:
            description: Minimum consecutive failures for the probe to
              be considered failed after having succeeded. Defaults to
              3. Minimum value is 1.
            format: int32
            type: integer
          httpGet:
            description: HTTPGet specifies the http request to perform.
            properties:
              host:
                description: Host name to connect to, defaults to the
                  pod IP. You probably want to set "Host" in httpHeaders
                  instead.
                type: string
              httpHeaders:
                description: Custom headers to set in the request. HTTP
                  allows repeated headers.
                items:
                  description: HTTPHeader describes a custom header to
                    be used in HTTP probes
                  properties:
                    name:
                      description: The header field name
                      type: string
                    value:
                      description: The header field value
                      type: string
                  required:
                    - name
                    - value
                  type: object
                type: array
              path:
                description: Path to access on the HTTP server.
                type: string
              port:
                anyOf:
                  - type: integer
                  - type: string
                description: Name or number of the port to access on the
                  container. Number must be in the range 1 to 65535. Name
                  must be an IANA_SVC_NAME.
                x-kubernetes-int-or-string: true
              scheme:
                description: Scheme to use for connecting to the host.
                  Defaults to HTTP.
                type: string
            required:
              - port
            type: object
          initialDelaySeconds:
            description: 'Number of seconds after the container has started
                                before liveness probes are initiated. More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes'
            format: int32
            type: integer
          periodSeconds:
            description: How often (in seconds) to perform the probe.
              Default to 10 seconds. Minimum value is 1.
            format: int32
            type: integer
          successThreshold:
            description: Minimum consecutive successes for the probe to
              be considered successful after having failed. Defaults to
              1. Must be 1 for liveness and startup. Minimum value is
              1.
            format: int32
            type: integer
          tcpSocket:
            description: 'TCPSocket specifies an action involving a TCP
                                port. TCP hooks not yet supported TODO: implement a realistic
                                TCP lifecycle hook'
            properties:
              host:
                description: 'Optional: Host name to connect to, defaults
                                    to the pod IP.'
                type: string
              port:
                anyOf:
                  - type: integer
                  - type: string
                description: Number or name of the port to access on the
                  container. Number must be in the range 1 to 65535. Name
                  must be an IANA_SVC_NAME.
                x-kubernetes-int-or-string: true
            required:
              - port
            type: object
          timeoutSeconds:
            description: 'Number of seconds after which the probe times
                                out. Defaults to 1 second. Minimum value is 1. More info:
                                https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes'
            format: int32
            type: integer
        type: object
      readinessProbe:
        description: Probe describes a health check to be performed against
          a container to determine whether it is alive or ready to receive
          traffic.
        properties:
          exec:
            description: One and only one of the following should be specified.
              Exec specifies the action to take.
            properties:
              command:
                description: Command is the command line to execute inside
                  the container, the working directory for the command  is
                  root ('/') in the container's filesystem. The command
                  is simply exec'd, it is not run inside a shell, so traditional
                  shell instructions ('|', etc) won't work. To use a shell,
                  you need to explicitly call out to that shell. Exit
                  status of 0 is treated as live/healthy and non-zero
                  is unhealthy.
                items:
                  type: string
                type: array
            type: object
          failureThreshold:
            description: Minimum consecutive failures for the probe to
              be considered failed after having succeeded. Defaults to
              3. Minimum value is 1.
            format: int32
            type: integer
          httpGet:
            description: HTTPGet specifies the http request to perform.
            properties:
              host:
                description: Host name to connect to, defaults to the
                  pod IP. You probably want to set "Host" in httpHeaders
                  instead.
                type: string
              httpHeaders:
                description: Custom headers to set in the request. HTTP
                  allows repeated headers.
                items:
                  description: HTTPHeader describes a custom header to
                    be used in HTTP probes
                  properties:
                    name:
                      description: The header field name
                      type: string
                    value:
                      description: The header field value
                      type: string
                  required:
                    - name
                    - value
                  type: object
                type: array
              path:
                description: Path to access on the HTTP server.
                type: string
              port:
                anyOf:
                  - type: integer
                  - type: string
                description: Name or number of the port to access on the
                  container. Number must be in the range 1 to 65535. Name
                  must be an IANA_SVC_NAME.
                x-kubernetes-int-or-string: true
              scheme:
                description: Scheme to use for connecting to the host.
                  Defaults to HTTP.
                type: string
            required:
              - port
            type: object
          initialDelaySeconds:
            description: 'Number of seconds after the container has started
                                before liveness probes are initiated. More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes'
            format: int32
            type: integer
          periodSeconds:
            description: How often (in seconds) to perform the probe.
              Default to 10 seconds. Minimum value is 1.
            format: int32
            type: integer
          successThreshold:
            description: Minimum consecutive successes for the probe to
              be considered successful after having failed. Defaults to
              1. Must be 1 for liveness and startup. Minimum value is
              1.
            format: int32
            type: integer
          tcpSocket:
            description: 'TCPSocket specifies an action involving a TCP
                                port. TCP hooks not yet supported TODO: implement a realistic
                                TCP lifecycle hook'
            properties:
              host:
                description: 'Optional: Host name to connect to, defaults
                                    to the pod IP.'
                type: string
              port:
                anyOf:
                  - type: integer
                  - type: string
                description: Number or name of the port to access on the
                  container. Number must be in the range 1 to 65535. Name
                  must be an IANA_SVC_NAME.
                x-kubernetes-int-or-string: true
            required:
              - port
            type: object
          timeoutSeconds:
            description: 'Number of seconds after which the probe times
                                out. Defaults to 1 second. Minimum value is 1. More info:
                                https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes'
            format: int32
            type: integer
        type: object
  availableWorkloadType:
    - server
---
apiVersion: core.kapp.dev/v1alpha1
kind: Application
metadata:
  name: test-configurable-plugin-sample-application
  namespace: kapp-test
spec:
  components:
    - image: nginx:alpine
      name: nginx-double
      workloadType: server
      pluginsNew:
        - name: kapp-configurable-probes
          config:
            readinessProbe:
              httpGet:
                path: /
                port: 80
              initialDelaySeconds: 5
              timeoutSeconds: 20
              periodSeconds: 5
              successThreshold: 1
              failureThreshold: 3
            livenessProbe:
              httpGet:
                path: /
                port: 80
              initialDelaySeconds: 50
              timeoutSeconds: 20
              periodSeconds: 5
              successThreshold: 1
              failureThreshold: 3
  isActive: true
